<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>控制器 | ServerHub 参考</title>
    <meta name="description" content="快速可靠的 Nodejs MVC 框架">
    <link rel="icon" href="/favicon.png">
  <link rel="manifest" href="/manifest.json">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:500,400,300|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/earlyaccess/notosansscsliced.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <script src="https://www.googletagmanager.com/gtag/js?id=UA-122724564-2" async="true"></script>
  <script src="/assets/inject.js" async="true"></script>
  <script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());

gtag('config', 'UA-122724564-2');</script>
    
    <link rel="preload" href="/assets/css/0.styles.b028f09f.css" as="style"><link rel="preload" href="/assets/js/app.1dd38295.js" as="script"><link rel="preload" href="/assets/js/27.7a506074.js" as="script"><link rel="prefetch" href="/assets/js/17.4e4c6ca5.js"><link rel="prefetch" href="/assets/js/2.54d91119.js"><link rel="prefetch" href="/assets/js/3.e3815ec9.js"><link rel="prefetch" href="/assets/js/4.b4bbe4df.js"><link rel="prefetch" href="/assets/js/5.ba8ae864.js"><link rel="prefetch" href="/assets/js/6.a5c16cdb.js"><link rel="prefetch" href="/assets/js/7.7c8bdfdf.js"><link rel="prefetch" href="/assets/js/8.14434d8a.js"><link rel="prefetch" href="/assets/js/9.b7b13cdb.js"><link rel="prefetch" href="/assets/js/10.ff6be549.js"><link rel="prefetch" href="/assets/js/11.48a539f4.js"><link rel="prefetch" href="/assets/js/12.45b463a5.js"><link rel="prefetch" href="/assets/js/13.1300dbff.js"><link rel="prefetch" href="/assets/js/14.c4afc325.js"><link rel="prefetch" href="/assets/js/15.ba1ba006.js"><link rel="prefetch" href="/assets/js/16.3ba8b27f.js"><link rel="prefetch" href="/assets/js/18.1c87f19d.js"><link rel="prefetch" href="/assets/js/19.4d0f19bb.js"><link rel="prefetch" href="/assets/js/20.cd6dced5.js"><link rel="prefetch" href="/assets/js/21.a3a63f2b.js"><link rel="prefetch" href="/assets/js/22.1194f43a.js"><link rel="prefetch" href="/assets/js/23.a00289aa.js"><link rel="prefetch" href="/assets/js/24.1ac289f3.js"><link rel="prefetch" href="/assets/js/25.dc6e9a8a.js"><link rel="prefetch" href="/assets/js/26.67142004.js"><link rel="prefetch" href="/assets/js/28.b3c35da4.js"><link rel="prefetch" href="/assets/js/29.0049cb67.js"><link rel="prefetch" href="/assets/js/30.892df537.js"><link rel="prefetch" href="/assets/js/31.5c0cd29b.js"><link rel="prefetch" href="/assets/js/32.2a374046.js"><link rel="prefetch" href="/assets/js/33.090937bb.js"><link rel="prefetch" href="/assets/js/34.4d223979.js"><link rel="prefetch" href="/assets/js/35.6e99ed1c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b028f09f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/zh/" class="home-link router-link-active"><!----><span class="site-name">
      ServerHub 参考
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/zh/tutorial/" class="nav-link">教程</a></div><div class="nav-item"><a href="/zh/document/" class="nav-link router-link-active">文档</a></div><div class="nav-item"><a href="/zh/about/" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">选择语言</span><span class="arrow right"></span></a><ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----><a href="/document/controller.html" class="nav-link">English</a></li><li class="dropdown-item"><!----><a href="/zh/document/controller.html" class="nav-link router-link-exact-active router-link-active">简体中文</a></li></ul></div></div><a href="https://github.com/ServerHubOrg/serverhub-mvc" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/zh/tutorial/" class="nav-link">教程</a></div><div class="nav-item"><a href="/zh/document/" class="nav-link router-link-active">文档</a></div><div class="nav-item"><a href="/zh/about/" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">选择语言</span><span class="arrow right"></span></a><ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----><a href="/document/controller.html" class="nav-link">English</a></li><li class="dropdown-item"><!----><a href="/zh/document/controller.html" class="nav-link router-link-exact-active router-link-active">简体中文</a></li></ul></div></div><a href="https://github.com/ServerHubOrg/serverhub-mvc" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav><ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>文档</span><!----></p><ul class="sidebar-group-items"><li><a href="/zh/document/" class="sidebar-link">开发文档</a></li><li><a href="/zh/document/run-module-method.html" class="sidebar-link">Instance.Run() 方法</a></li><li><a href="/zh/document/controller.html" class="active sidebar-link">控制器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zh/document/controller.html#创建-controllers-文件" class="sidebar-link">创建 controllers 文件</a></li><li class="sidebar-sub-header"><a href="/zh/document/controller.html#活跃于-compile-time-和静态的-controller" class="sidebar-link">活跃于 compile-time 和静态的 Controller</a></li><li class="sidebar-sub-header"><a href="/zh/document/controller.html#controller-作用域变量" class="sidebar-link">Controller 作用域变量</a></li><li class="sidebar-sub-header"><a href="/zh/document/controller.html#关于-controller-中的-action-方法" class="sidebar-link">关于 controller 中的 action 方法</a></li><li class="sidebar-sub-header"><a href="/zh/document/controller.html#关于-controller-特殊的语法" class="sidebar-link">关于 controller 特殊的语法</a></li><li class="sidebar-sub-header"><a href="/zh/document/controller.html#本章节特别感谢" class="sidebar-link">本章节特别感谢</a></li></ul></li><li><a href="/zh/document/route.html" class="sidebar-link">路由</a></li><li><a href="/zh/document/plugin.html" class="sidebar-link">插件系统</a></li><li><a href="/zh/document/middleware.html" class="sidebar-link">中间件</a></li><li><a href="/zh/document/archive.html" class="sidebar-link">归档</a></li></ul></div></li></ul></div><div class="page"><div class="content"><h1 id="控制器"><a href="#控制器" aria-hidden="true" class="header-anchor">#</a> 控制器</h1><p>Controllers 被用来处理访问服务器程序的大多数通过路由选择的请求。当某个特定的路由规则被匹配了，则 ServerHub 会调用该 controller 中的对应 action 方法来处理这个请求，并将处理结果返回给请求者（往往是浏览器）。</p><h2 id="创建-controllers-文件"><a href="#创建-controllers-文件" aria-hidden="true" class="header-anchor">#</a> 创建 controllers 文件</h2><p>每个 controller 和 JavaScript 文件形成一一对应的关系。请看这个 <code>home.js</code> 自定义 controller 的例子（过时的写法，不再推荐；请阅读最后的控制器语法说明）：</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">return</span> <span class="token punctuation">{</span>
  index<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> method<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">View</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  primary<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> method<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> context <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">View</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    context<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;Ziyuan&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> context<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>下面是 <strong>推荐</strong> 的写法 <code>v1.0.3+</code>:</p><div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  index<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> method<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">View</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  primary<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> method<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> context <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">View</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    context<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;Ziyuan&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> context<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>Controller 文件就是平常却又特殊的 JavaScript 文件。你必须在文件内直接返回一个带有 <code>action functions</code> 方法定义的对象。只有这样，当 ServerHub 要派发路由后的请求时，你的自定义 controller 才会被调用到。</p><p>也许你会感到奇怪，为什么 ServerHub 的 controller 是这样的语法：将 return 语句写在了函数体的外面（或者根本没有函数体）。尤其是当你使用 lint 工具时它们还会报错。不要担心，暂时不要纠结，这个问题我们在后面就会讲到。</p><p>在 controller 方法定义中，有三个参数是 <code>必须</code> 的，它们是：request、response 和 method</p><ul><li>request 是对 Node.js IncomingMessage 对象的引用，也就是 HTTPRequest。</li><li>response 则是对 ServerResponse（非完整）对象的引用，即 HTTPResponse。</li><li>method 则是一个表示当前 HTTPMethod 的参数，其值通常是：GET、POST、PATCH、UPDATE、DELETE 和 PUT。</li></ul><p>下面两个参数不是必须的，但是也非常有用：</p><ul><li>id 是由匹配到的路由中提取出的 id 值。</li><li>search 是从 URL 解析出的查询内容，是一个 JavaScript Map 对象。</li></ul><h2 id="活跃于-compile-time-和静态的-controller"><a href="#活跃于-compile-time-和静态的-controller" aria-hidden="true" class="header-anchor">#</a> 活跃于 compile-time 和静态的 Controller</h2><p>这里说明一下，compile-time 不能理解为字面的编译过程，而应该理解为 ServerHub 对你的配置进行加载、处理和执行的过程，对应 runtime 则是当 HTTP 请求接入 ServerHub 时产生的一系列动作对应的时机。如果你在 compile-time 之后对任何 controller 文件进行了修改，到浏览器刷新看看是否你的修改被应用上了。可以发现，完全没有任何变化。ServerHub 仅仅会在 compile-time 加载和注册 controller，而当注册完毕，所有内容都会被缓存下来，当程序执行的时候，你的修改也就被忽略了。</p><p>不像是 view 和 model 等等资源，ServerHub 对它们采用的策略是动态加载，ServerHub 会跟踪文档的修改操作，一旦进行了修改，就会更新内部缓存（关于缓存，请参阅相关章节），从而保证内容最新而且访问速度足够快。</p><p>所以永远不要尝试在程序启动之后修改这些程序文件。</p><h2 id="controller-作用域变量"><a href="#controller-作用域变量" aria-hidden="true" class="header-anchor">#</a> Controller 作用域变量</h2><p>有这么一些变量，你只能在 controller 的 action 方法执行时才能访问到这些变量。要使用它们，你需要显式使用 this 指针指向当前的 controller 实例。否则，程序将会报错。</p><p>建议你在适当的时候多使用 ECMAScript 2015 引入的 <strong>arrow functions（箭头函数）</strong>。或者是使用一些变通的方法，比如闭包或者是其他手段，这样你的 this 指针就不会乱掉了。</p><p>如果你在 <code>v1.0.2</code> 之前就已经用过 ServerHub，那么你很有可能会误认为新的模块加载函数是控制器作用域变量。其实不然，详细信息会在 <a href>模块</a> 相关章节提供描述。</p><h3 id="当前所有可以使用的-controller-作用域变量："><a href="#当前所有可以使用的-controller-作用域变量：" aria-hidden="true" class="header-anchor">#</a> 当前所有可以使用的 controller 作用域变量：</h3><p>在以后的章节中会详细介绍这些变量的使用方法（ 控制器作用域变量），不过一些返回基本值（比如 <code>string</code>、 <code>number</code> 等等的就不会被包括在内了（还有一些为 Node.js 原生对象的别名也不会赘述）。</p><ul><li><code>View()</code><strong><em>Function</em></strong> 返回由 model/ 目录下文件定义的 model 对象。</li><li><code>Runtime</code><strong><em>Object</em></strong> 提供许多运行时对象和属性
<ol><li><code>Runtime.DBProvider</code><strong><em>Object</em></strong> 对 database provider 对象的引用（默认使用 MySQL，但可以在配置文件中修改）。</li><li><code>Runtime.FileHelper</code><strong><em>Object</em></strong> 对 FileHelper 对象的引用，它提供了一些访问文件系统的便捷方法，区别于 Node.js 的 fs 和 path 模块。</li><li><code>Runtime.WAIT</code><strong><em>boolean</em></strong> 控制 ServerHub 等待异步操作完成。</li></ol></li><li><code>System</code><strong><em>Object</em></strong> 提供对 ServerHub 内部一些常量的访问性
<ol><li><code>System.Version</code><strong><em>string</em></strong> ServerHub 版本号</li><li><code>System.NodeVersion</code><strong><em>string</em></strong> Node.js 版本号</li><li><code>System.Platform</code><strong><em>string</em></strong> 操作系统的平台信息（如 win32, linux 等等）</li><li><code>System.Hardware</code><strong><em>Object</em></strong> 操作系统的硬件相关信息
<ul><li><code>System.Hardware.TotalMemory</code><strong><em>number</em></strong> 已安装内存（单位 byte）</li><li><code>System.Hardware.FreeMemory</code><strong><em>number</em></strong> 空闲内存（单位 byte）</li><li><code>System.Hardware.NetworkInterfaces</code><strong><em>Object</em></strong> 返回本机所有已经注册了 IP 地址的网络接口信息</li></ul></li><li><code>System.Die(exit_code)</code><strong><em>Function</em></strong> 强行终结 ServerHub 实例</li></ol></li></ul><h2 id="关于-controller-中的-action-方法"><a href="#关于-controller-中的-action-方法" aria-hidden="true" class="header-anchor">#</a> 关于 controller 中的 action 方法</h2><p>Action 方法是当 HTTP 请求进入时由路由和 controller 共同触发的一些函数。它处理请求和响应，控制返回的内容。这一部分，我们会讨论 controller 中的 action 方法。这一部分内容对于理解 controller 有很大的帮助。</p><h3 id="怎么写一个-action-方法？"><a href="#怎么写一个-action-方法？" aria-hidden="true" class="header-anchor">#</a> 怎么写一个 action 方法？</h3><div class="language-js extra-class"><pre class="language-js"><code>index<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> method<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// do something</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">View</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这就是一个非常简单的叫做 index 的 action 方法。你只需要将它定义为 controller 返回的对象的某一个方法即可。而要注意的就是在其中使用 controller 作用域变量时，一定要记住加上“this”引用。</p><p>Action 方法的三个参数都是必须的，如果你想要手动控制返回的 HTTP 响应内容，可以用 <code>res.write()</code> 一类的方法来进行，ServerHub 就会忽略掉 model 中的内容以及相关的渲染引擎，然后根据你的要求来操作。</p><div class="language-js extra-class"><pre class="language-js"><code>index<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> method<span class="token punctuation">)</span><span class="token punctuation">{</span>
    response<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'Hello, XWZ'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">View</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这段代码会返回“Hello, XWZ”这段字符（通常显示在浏览器界面里），而后面的返回语句是不会生效的。</p><p>注意 <code>request</code> 参数是原生的 Node.js <code>IncomingMessage</code> 对象（在 ServerHub 0.0.7 版本中仍然是）。但 <code>response</code> 参数则是一个假的 <code>ServerResponse</code> 对象。ServerHub 在其中打包了不少来自原生对象的方法和属性，这样你在使用时就不会感到太困惑。不过具体的调用方法还请阅读相关章节。 <code>Method</code> 是表示 HTTP 请求类型的字符串。</p><h3 id="action-方法命名规范"><a href="#action-方法命名规范" aria-hidden="true" class="header-anchor">#</a> Action 方法命名规范</h3><p>Action 方法名必须是小写的字符组成。你可以使用字母“a”到“z”以及数字和下划线。有一些名字是保留词，你不得在 action 方法名中使用这些值：Runtime、System、Console 或是 View。</p><p>命名的最佳实践是使用简短的单词，推荐你使用动词来命名。每个 action 方法的名字如果超过了 20 个字符，就显得不太妥当。并且希望你注意，今后的版本中，可能会强行限制其长度，那样子将导致为旧版本编写的应用程序无法启动。</p><h2 id="关于-controller-特殊的语法"><a href="#关于-controller-特殊的语法" aria-hidden="true" class="header-anchor">#</a> 关于 controller 特殊的语法</h2><div class="warning custom-block"><p class="custom-block-title">警告</p><p>自 <code>v1.0.3</code> 之后就不再推荐此写法了，并且在将来的某个版本中，将会全面禁止使用此语法。</p></div><p><s>前面我们说过，如果你用了 lint 工具，那么 ServerHub 的 controller 文件将会引起一些语法错误。可能它会提示“ 在函数外使用了 return 语句”。不过其实你所写的是正确的、合法的 部分 JavaScript 文件。</s></p><p><s>Controllers 脚本其实都是 函数，它们并不是完全独立的 JavaScript 函数。当你尝试直接运行 controller 文件时，是不会有效果的。</s></p><p><s>下面举例说明：（ home.js）：</s></p><div class="language-js extra-class"><pre class="language-js"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">return</span> <span class="token punctuation">{</span>
  index<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> method<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">View</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p><s>如果你把这个 home.js 当作平常的 JavaScript 文件，那么就还需在 return 语句之外加上一个函数的花括号，像这样：</s></p><div class="language-js extra-class"><pre class="language-js"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        index<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> method<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">View</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><s>好了，现在它成了标准的 JavaScript 文件了。</s></p><p><s>但是，不知道你还记不记得 controllers 全部都是 函数 ？这意味着什么？你的 controller 整个就是一个函数，它的隐形边界（文件）就是函数的花括号。所以，如果我们强行加上了花括号，原来的 controller 文件就成了这个样子：</s></p><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            index<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> method<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">View</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><s>可见，这里产生了一个多余的函数包围，留它何用？直接去掉就好了。这也就是我们称 ServerHub 的 controller 是“部分 JavaScript 文件”的原因了。</s></p><p>不过请不要担心，ServerHub 将会持续支持旧的方式，直到 <code>v2.0.0</code> 版本（最早）。你将有充分的时间来迁移到新的模块加载语法。</p><h3 id="控制器的模块化写法"><a href="#控制器的模块化写法" aria-hidden="true" class="header-anchor">#</a> 控制器的模块化写法</h3><p>石超 曾告诉过我，他的 IDE 在他用“非完全 JavaScript 风格”写控制器时报错了。随着 ServerHub 的开发和完善，原来的那种创作控制器的方法显得难以拓展。所以我使用控制器作用域变量来对一些对象、函数进行引用，从而提供完整的功能支持。说实在的，一开始当所有东西都限制在控制器作用域当中的时候，这种方法其实很有效，也很优美。但是当逐渐拓展到更广的 context 中时，就显得复杂和难以拓展了。我不得不重新思考石超的提醒，于是在经过几次修改之后加入了模块化写法的控制器创作方式。</p><p>新的写法其实非常简单。你只需要把 <code>return</code> 换成 <code>module.exports =</code> 即可。</p><p>但是这还不是全部！这还不是全部！这还不是全部！千万不要忘记把文件名的后缀从“.js”改成“.shc.js”：</p><p><code>home.js =&gt; home.shc.js</code><code>language.js =&gt; language.shc.js</code></p><p>这是 必须进行的，否则 ServerHub 会直接将它作为旧风格加载，并抛出错误。</p><p>另外，有一点也是你需要注意的：如果你的控制器目录中包含一个以“.shc.js”结尾的文件，则 ServerHub 不会再加载任何旧语法的控制器。所以一定要保证工作空间干干净净。或者呢，就在指定控制器目录的同时（缺省值“controller/”），再显式指明要注册的文件吧，这样一来 ServerHub 就会帮你搞定了。</p><h2 id="本章节特别感谢"><a href="#本章节特别感谢" aria-hidden="true" class="header-anchor">#</a> 本章节特别感谢</h2><p><a href="https://github.com/ShiChao1996" target="_blank" rel="noopener noreferrer">石超<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 他提醒了我 controller 文件中的语法问题，非常感谢！</p></div><div class="page-edit"><div class="edit-link"><a href="https://github.com/ServerHubOrg/serverhub-docs/edit/dev/docs/zh/document/controller.md" target="_blank" rel="noopener noreferrer">在 Github 上编辑此页</a><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div><!----></div><div class="page-nav"><p class="inner"><span class="prev"><i class="material-icons">arrow_back</i><a href="/zh/document/run-module-method.html" class="prev">
          Instance.Run() 方法
        </a></span><span class="next"><a href="/zh/document/route.html">
          路由
        </a><i class="material-icons">arrow_forward</i></span></p></div></div></div></div>
    <script src="/assets/js/27.7a506074.js" defer></script><script src="/assets/js/app.1dd38295.js" defer></script>
  </body>
</html>
