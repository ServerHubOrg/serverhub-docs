<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Instance.Run() 方法 | ServerHub 参考</title>
    <meta name="description" content="快速可靠的 Nodejs MVC 框架">
    <link rel="icon" href="/favicon.png">
  <link rel="manifest" href="/manifest.json">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:500,400,300|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/earlyaccess/notosansscsliced.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <script src="https://www.googletagmanager.com/gtag/js?id=UA-122724564-2" async="true"></script>
  <script src="/assets/inject.js" async="true"></script>
  <script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());

gtag('config', 'UA-122724564-2');</script>
    
    <link rel="preload" href="/assets/css/0.styles.b028f09f.css" as="style"><link rel="preload" href="/assets/js/app.1dd38295.js" as="script"><link rel="preload" href="/assets/js/31.5c0cd29b.js" as="script"><link rel="prefetch" href="/assets/js/17.4e4c6ca5.js"><link rel="prefetch" href="/assets/js/2.54d91119.js"><link rel="prefetch" href="/assets/js/3.e3815ec9.js"><link rel="prefetch" href="/assets/js/4.b4bbe4df.js"><link rel="prefetch" href="/assets/js/5.ba8ae864.js"><link rel="prefetch" href="/assets/js/6.a5c16cdb.js"><link rel="prefetch" href="/assets/js/7.7c8bdfdf.js"><link rel="prefetch" href="/assets/js/8.14434d8a.js"><link rel="prefetch" href="/assets/js/9.b7b13cdb.js"><link rel="prefetch" href="/assets/js/10.ff6be549.js"><link rel="prefetch" href="/assets/js/11.48a539f4.js"><link rel="prefetch" href="/assets/js/12.45b463a5.js"><link rel="prefetch" href="/assets/js/13.1300dbff.js"><link rel="prefetch" href="/assets/js/14.c4afc325.js"><link rel="prefetch" href="/assets/js/15.ba1ba006.js"><link rel="prefetch" href="/assets/js/16.3ba8b27f.js"><link rel="prefetch" href="/assets/js/18.1c87f19d.js"><link rel="prefetch" href="/assets/js/19.4d0f19bb.js"><link rel="prefetch" href="/assets/js/20.cd6dced5.js"><link rel="prefetch" href="/assets/js/21.a3a63f2b.js"><link rel="prefetch" href="/assets/js/22.1194f43a.js"><link rel="prefetch" href="/assets/js/23.a00289aa.js"><link rel="prefetch" href="/assets/js/24.1ac289f3.js"><link rel="prefetch" href="/assets/js/25.dc6e9a8a.js"><link rel="prefetch" href="/assets/js/26.67142004.js"><link rel="prefetch" href="/assets/js/27.7a506074.js"><link rel="prefetch" href="/assets/js/28.b3c35da4.js"><link rel="prefetch" href="/assets/js/29.0049cb67.js"><link rel="prefetch" href="/assets/js/30.892df537.js"><link rel="prefetch" href="/assets/js/32.2a374046.js"><link rel="prefetch" href="/assets/js/33.090937bb.js"><link rel="prefetch" href="/assets/js/34.4d223979.js"><link rel="prefetch" href="/assets/js/35.6e99ed1c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b028f09f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/zh/" class="home-link router-link-active"><!----><span class="site-name">
      ServerHub 参考
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/zh/tutorial/" class="nav-link">教程</a></div><div class="nav-item"><a href="/zh/document/" class="nav-link router-link-active">文档</a></div><div class="nav-item"><a href="/zh/about/" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">选择语言</span><span class="arrow right"></span></a><ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----><a href="/document/run-module-method.html" class="nav-link">English</a></li><li class="dropdown-item"><!----><a href="/zh/document/run-module-method.html" class="nav-link router-link-exact-active router-link-active">简体中文</a></li></ul></div></div><a href="https://github.com/ServerHubOrg/serverhub-mvc" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/zh/tutorial/" class="nav-link">教程</a></div><div class="nav-item"><a href="/zh/document/" class="nav-link router-link-active">文档</a></div><div class="nav-item"><a href="/zh/about/" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">选择语言</span><span class="arrow right"></span></a><ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----><a href="/document/run-module-method.html" class="nav-link">English</a></li><li class="dropdown-item"><!----><a href="/zh/document/run-module-method.html" class="nav-link router-link-exact-active router-link-active">简体中文</a></li></ul></div></div><a href="https://github.com/ServerHubOrg/serverhub-mvc" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav><ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>文档</span><!----></p><ul class="sidebar-group-items"><li><a href="/zh/document/" class="sidebar-link">开发文档</a></li><li><a href="/zh/document/run-module-method.html" class="active sidebar-link">Instance.Run() 方法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zh/document/run-module-method.html#serverhub-run" class="sidebar-link">ServerHub.Run()</a></li><li class="sidebar-sub-header"><a href="/zh/document/run-module-method.html#instance-run-参数配置" class="sidebar-link">Instance.Run() 参数配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zh/document/run-module-method.html#越简单越好" class="sidebar-link">越简单越好</a></li><li class="sidebar-sub-header"><a href="/zh/document/run-module-method.html#其他的配置参数" class="sidebar-link">其他的配置参数</a></li></ul></li><li class="sidebar-sub-header"><a href="/zh/document/run-module-method.html#方法返回值-v1-6-0" class="sidebar-link">方法返回值 v1.6.0</a></li></ul></li><li><a href="/zh/document/controller.html" class="sidebar-link">控制器</a></li><li><a href="/zh/document/route.html" class="sidebar-link">路由</a></li><li><a href="/zh/document/plugin.html" class="sidebar-link">插件系统</a></li><li><a href="/zh/document/middleware.html" class="sidebar-link">中间件</a></li><li><a href="/zh/document/archive.html" class="sidebar-link">归档</a></li></ul></div></li></ul></div><div class="page"><div class="content"><h1 id="instance-run-方法"><a href="#instance-run-方法" aria-hidden="true" class="header-anchor">#</a> Instance.Run() 方法</h1><h2 id="serverhub-run"><a href="#serverhub-run" aria-hidden="true" class="header-anchor">#</a> ServerHub.Run()</h2><p><a href="/zh/tutorial/getting-started.html#使用">本节请查看这里</a></p><h2 id="instance-run-参数配置"><a href="#instance-run-参数配置" aria-hidden="true" class="header-anchor">#</a> Instance.Run() 参数配置</h2><p>前些天，我们了解了 <code>instance.Run()</code> 方法。本章我们会继续探讨该方法的第一个配置参数： <code>instance.Run()</code> 的配置对象。</p><h3 id="越简单越好"><a href="#越简单越好" aria-hidden="true" class="header-anchor">#</a> 越简单越好</h3><p>与之前我们在 <a href="/zh/tutorial/getting-started.html#使用">Instance.Run()</a> 一章中看到的不同，那个配置对象太复杂了。事实上，只有一个参数是必要的，那就是： <code>BaseDir</code>.</p><p>BaseDir 是 服务器的根目录，它会被 ServerHub 应用程序引用于其生命周期的各个阶段。如果你的入口文件，比如 app.js，刚好位于你的服务器根目录，则只需将 <code>__dirname</code> 传过去即可。</p><p>这就是能够让你的 ServerHub 应用正常工作的最基本配置了。</p><h3 id="其他的配置参数"><a href="#其他的配置参数" aria-hidden="true" class="header-anchor">#</a> 其他的配置参数</h3><p>自定义 ServerHub 时需要一些额外的配置。</p><h4 id="webdir"><a href="#webdir" aria-hidden="true" class="header-anchor">#</a><code>WebDir</code></h4><p><code>WebDir</code> 就是你网站的根目录。你的页面文件、资源文件、脚本文件和素材都应该被放在这里面。ServerHub 默认使用“www/”作为其值。如果你要设置一个另外的网站根目录，请先创建一个目录，并将其名字传给 <code>WebDir</code> 属性。</p><h4 id="controllerdir"><a href="#controllerdir" aria-hidden="true" class="header-anchor">#</a><code>ControllerDir</code></h4><p>我们都知道，ServerHub 会把 HTTP 请求分发到 controller 上，如果要注册 controller，就应当指定 controller 所在的目录。所使用的 controller 目录应该是一个相对于服务器根目录的相对路径，ServerHub 中默认用“controller/”。</p><h4 id="controllers"><a href="#controllers" aria-hidden="true" class="header-anchor">#</a><code>Controllers</code></h4><p>有些情况下，我们不希望 controller 目录下的所有文件都被注册进去（比如你放置了非控制器的文件）。那么此时，可以将所需的文件名通过数组传给此属性。比如： <code>['home.js', 'data.js']</code>。但如果你想把所有的文件都一并注册了，很简单，不要加入此属性即可。ServerHub 会自动扫描并注册 <code>ControllerDir</code> 中所有文件。</p><h4 id="viewdir-和-modeldir"><a href="#viewdir-和-modeldir" aria-hidden="true" class="header-anchor">#</a><code>ViewDir</code> 和 <code>ModelDir</code></h4><p>与 <code>ControllerDir</code> 类似，它们用于存放视图和模型。</p><h4 id="dbprovider"><a href="#dbprovider" aria-hidden="true" class="header-anchor">#</a><code>DBProvider</code></h4><p>通过此属性执行你所需的数据库支持包。当前版本你只可以使用 MySQL，也就是把“mysql”赋值给 DBProvider。</p><h4 id="dbconnectionstring"><a href="#dbconnectionstring" aria-hidden="true" class="header-anchor">#</a><code>DBConnectionString</code></h4><p>如果你只有一个数据库实例要使用，那么我建议你将一个全局数据库连接字符串传入 ServerHub。因为如果你不这样，你就必须要在每次调用 <code>GetConnection()</code> 方法时传入数据库连接字符串。</p><h4 id="maxcachesize"><a href="#maxcachesize" aria-hidden="true" class="header-anchor">#</a><code>MaxCacheSize</code></h4><p>此属性与 ServerHub 的缓存分配机制有关。如果文件大小超过了此配额，那么 ServerHub 就会通过 WCS 机制来主动卸载一些缓存，这个机制会在后面的章节详谈。</p><h4 id="defaultpages"><a href="#defaultpages" aria-hidden="true" class="header-anchor">#</a><code>DefaultPages</code></h4><p>ServerHub 在处理默认页时引入了一个优先匹配和回滚策略。你的默认页必须放在 WebDir 目录。默认情况下，ServerHub 会首先寻找“index.html”，然后再找“default.html”，如果还是没有，就去寻找“page.html”。当然，你可以用一个形如 <code>['hello.html', 'first.html']</code> 的数组来强制覆盖此回滚策略。</p><h4 id="pagenotfound-v0-0-93"><a href="#pagenotfound-v0-0-93" aria-hidden="true" class="header-anchor">#</a><code>PageNotFound</code><code>v0.0.93+</code></h4><p>一旦收到的请求不能找到对应的资源，或是没有相应的路由规则可以匹配，则 ServerHub 会渲染出 404 NOT Found 的页面返回。而从 v0.0.93 开始，你可以自己来指定这个错误页了。</p><h4 id="asyncoperationtimeout-v0-0-97"><a href="#asyncoperationtimeout-v0-0-97" aria-hidden="true" class="header-anchor">#</a><code>AsyncOperationTimeout</code><code>v0.0.97+</code></h4><p>自从 <code>v0.0.96</code> 引入 <code>this.Runtime.WAIT</code> 信号量之后，我们已经可以在控制器中实现一些耗时的异步操作逻辑，比如数据库查询操作。但是你应该知道，这个信号量其实是非常危险的，因为如果你忘记将其置为 <code>false</code> 或是因为操作太耗时而在中间过程中断开连接，则可能会出现严重的问题（得不到相应，甚至服务器程序崩溃）。所以 ServerHub 内置了倒数计时，如果操作时间超过这个阈值，则会停止等待，立即返回响应（可能是空响应）。在返回响应的同时，还会在服务器端的控制台输出错误信息（此输出特性可能在将来的版本中移除或迁移到日志中）。默认阈值为 10 秒钟，你可以通过将此变量传入来缩短或延长该值。（单位为 <strong>毫秒</strong>）</p><p>感谢阅读本章节，更多属性会在以后的更新中补充。</p><h4 id="tlsoption-v1-0-6"><a href="#tlsoption-v1-0-6" aria-hidden="true" class="header-anchor">#</a><code>TLSOption</code><code>v1.0.6+</code></h4><p>自 <code>v1.0.6</code> 开始，ServerHub 大大增强了连接安全性。你可以通过此属性来配置 TLS 证书。此属性由 4 个子属性构成： <code>Key: string、 Cert: string、 CA: string</code> 和 <code>Port: Array&lt;string&gt;|Array&lt;number&gt;|number|string</code>。你需要把私钥与证书载入并赋值给上述属性，然后把需要 TLS 连接的端口号指定给 Port 属性。</p><p>这里有一则<a href="/zh/tutorial/tls-tutorial.html">教程</a>帮助你使用 TLS。</p><h4 id="socketoptions-v1-6-0"><a href="#socketoptions-v1-6-0" aria-hidden="true" class="header-anchor">#</a> SocketOptions <code>v1.6.0</code></h4><p><code>v1.6.0</code> 之后，ServerHub 将会开放和逐渐完善其对 WebSocket 的支持。这一重要特性将会极大拓展你使用它来开发实时应用程序的能力。比如一个在线的聊天室或是广播系统。通常，你可以将 ServerHub 的 WebSocket 侦听对象附着于任意的服务器端口上，甚至是 TLS 端口。</p><p>对于通信的另一端（通常是浏览器，此处以浏览器为例），你仅仅需要使用：</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">'ws://hostname:port/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">'wss://hostname:port/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// TLS</span>
</code></pre></div><p>即可建立连接。</p><p>此配置对象有两个属性：</p><ul><li><code>Port</code> 可以是一个单一端口号或是一组端口号。但是它必须是全局配置对象中 <code>Port</code> 值的子集。</li><li><code>ConnectionCallback</code> 是一个回调函数，它将在有 WebSocket 请求建立连接时执行。此函数接收一个 <a href="https://github.com/websockets/ws" target="_blank" rel="noopener noreferrer">WebSocket<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 对象作为参数。</li></ul><p>下面说说 TLS 支持的特殊之处。早在 ServerHub 的 <code>v1.0.6</code> 版本中，开发者就可以享受安全的 TLS 支持了。彼时，你可以使用自签署的 TLS 证书在本地进行调试。但是 WebSocket 完全不同，你无法再使用自签署的证书来支持基于 TLS 的 WebSocket 了。你的浏览器会因为证书授权方不合法而拒绝建立连接。</p><h2 id="方法返回值-v1-6-0"><a href="#方法返回值-v1-6-0" aria-hidden="true" class="header-anchor">#</a> 方法返回值 <code>v1.6.0</code></h2><p>此方法返回了具有两个属性的对象。</p><ul><li><code>Servers</code> （数组）</li><li><code>Sockets</code> （数组）</li></ul><p><code>Servers</code> 包含了所有成功启动并侦听你所指定的端口的 HTTP/HTTPS 服务器实例。<code>Sockets</code> 则包括了所有附着在既有 HTTP/HTTPS 服务实例的 WebSocket 监听对象。</p></div><div class="page-edit"><div class="edit-link"><a href="https://github.com/ServerHubOrg/serverhub-docs/edit/dev/docs/zh/document/run-module-method.md" target="_blank" rel="noopener noreferrer">在 Github 上编辑此页</a><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div><!----></div><div class="page-nav"><p class="inner"><span class="prev"><i class="material-icons">arrow_back</i><a href="/zh/document/" class="prev router-link-active">
          开发文档
        </a></span><span class="next"><a href="/zh/document/controller.html">
          控制器
        </a><i class="material-icons">arrow_forward</i></span></p></div></div></div></div>
    <script src="/assets/js/31.5c0cd29b.js" defer></script><script src="/assets/js/app.1dd38295.js" defer></script>
  </body>
</html>
